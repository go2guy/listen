<?xml version="1.0"?>
<vxml version="2.0" application="file:/interact/apps/spotbuild/ippbx/root.vxml">
    <!-- Last Modified 01/24/2011
       *   @Name	chkFwdType.vxml
       *   @Desc	This script is part of the logic for forwarding / cancelling
                    a forwarded extension. Here, we figure out the action the caller
                    is trying to perform. -->

    <!-- Passed in from ippbx_main.ccxml -->
    <var name="ANI"/>
    <var name="DNIS"/>
    <var name="importedValue"/>
    <var name="EXT_LENGTH"/>

    <!-- Global Variable -->
    <var name="passCodeLngth" expr="10"/>

	<form id="beginDocument">
		<block>
	        <log>INFO: Entered beginDocument</log>
            <assign name="listenArgs" expr="importedValue"/>    <!-- Save off controller information -->
            <assign name="flag" expr="whichFlag"/>
            <assign name="fldTrmChar" expr="'#'"/>
            <assign name="digitTimeOut" expr="'3s'"/>
            <assign name="fieldTimeOut" expr="'4s'"/>
            <assign name="cutIn" expr="'true'"/>
            <assign name="gotoForm" expr="'#userKeyPress'"/>
            <if cond="mBox.length == 0">
                <goto next="#getMbx"/>
            <else/>
                <assign name="extension" expr="mBox"/>
                <if cond="flag == 'cancelFWD'">
                    <goto expr="'file:'+TRANS_PATH+'validatePasscode.vxml'"/>
                <else/>
                    <goto next="#getPasscode"/>
                </if>
            </if>
        </block>
    </form>

    <form id="getMbx">
        <!-- Set up parameters that are used by the play audio subdialog for get mailbox -->
        <block>
            <log>INFO: Entered getMbx</log>
            <log target="status">Get Mailbox</log>
            <assign name="status" expr="'mailBox'"/>
            <assign name="fieldLength" expr="parseInt(EXT_LENGTH) - 1"/>
            <assign name="promptID" expr="'APgetMbx'"/>
            <assign name="tmpVal" expr="'APgetMbx'"/>
			<goto next="#playAudio"/>
        </block>
    </form>

    <form id="getPasscode">
        <!-- Set up parameters that are used by the play audio subdialog for get pass code -->
        <block>
            <log>INFO: Entered getPasscode</log>
            <log target="status">Get Pass Code</log>
            <assign name="status" expr="'passCode'"/>
            <assign name="fieldLength" expr="passCodeLngth"/>
            <assign name="promptID" expr="'APgetPasscode'"/>
            <assign name="tmpVal" expr="'APgetPasscode'"/>
			<goto next="#playAudio"/>
        </block>
    </form>

    <form id="playAudio">
        <!-- This form allows us to play a prompt and capture a user's response. We
        use it to play the various prompts found in this script -->
        <block>
            <log>INFO: Entered playAudio</log>
        </block>
        <subdialog name="playAudio" srcexpr="'file:'+APP_PATH+'getUserEntry.vxml'">
            <param name="dgtTimeOut" expr="digitTimeOut"/>
            <param name="fldLength" expr="fieldLength"/>
            <param name="fldTermchar" expr="fldTrmChar"/>
            <param name="fldTimeOut" expr="fieldTimeOut"/>
            <param name="interrupt" expr="cutIn"/>
            <param name="hotKey" expr="'*'"/>
            <param name="file" expr="promptID"/>
        </subdialog>
        <block>
            <assign name="userEntry" expr="playAudio.userEntry"/>
            <if cond="userEntry == 'hangup'">
                <assign name="status" expr="'endCall'"/>
                <goto next="#exit"/>
            <else/>
                <goto expr="gotoForm"/>
            </if>
        </block>
    </form>

    <form id="userKeyPress">
        <!-- In here, we analyse the user's key press and progress accordingly -->
        <block>
            <log>INFO: Entered userKeyPress</log>
            <if cond="((status == 'passCode') &amp;&amp; (userEntry == '*'))">  <!-- Assume caller wants to enter mailbox -->
                <log target="status">Get Mailbox</log>
                <!-- To prevent an endless loop, we'll use a counter here -->
                <assign name="mbxCnt" expr="mbxCnt + 1"/>
                <if cond="mbxCnt &lt; MAX_ERR">
                    <goto next="#getMbx"/>
                <else/>
                    <assign name="promptID" expr="'APgoodbye'"/>
                    <assign name="status" expr="'endCall'"/>
                    <assign name="gotoForm" expr="'#exit'"/>
                    <goto next="#playAudio"/>
                </if>
            <elseif cond="((status == 'mailBox') &amp;&amp; (userEntry.length != fieldLength))"/>
                <!-- Assume caller did not enter a valid mailbox number -->
            <elseif cond="userEntry.length == 0"/>
                <!-- Assume caller did not enter any value for mailbox, pass code or destination number -->
            <elseif cond="status == 'destination'"/>
                <assign name="destination" expr="userEntry"/>
                <goto expr="'file:'+TRANS_PATH+'forward.vxml'"/>
            <else/>
                <if cond="status == 'mailBox'">
                    <assign name="extension" expr="userEntry"/>
                    <if cond="flag == 'cancelFWD'">
                        <goto expr="'file:'+TRANS_PATH+'validatePasscode.vxml'"/>
                    <else/>
                        <goto next="#getPasscode"/>
                    </if>
                <else/>
                    <assign name="passcode" expr="userEntry"/>
                    <goto expr="'file:'+TRANS_PATH+'validatePasscode.vxml'"/>
                </if>
            </if>
            <goto next="#error"/>
        </block>
    </form>

    <form id="error">
        <!-- In here, we handle the error sequence -->
        <block>
            <log>INFO: Entered error</log>
            <assign name="errCnt" expr="errCnt + 1"/>
            <if cond="errCnt &lt; MAX_ERR">
                <if cond="errCnt == 1">
                    <assign name="promptID" expr="'APerr1|'+tmpVal"/>
                <else/>
                    <assign name="promptID" expr="'APerr2|'+tmpVal"/>
                </if>
                <assign name="gotoForm" expr="'#userKeyPress'"/>
            <else/>
                <log target="status">Goodbye</log>
                <assign name="promptID" expr="'APmaxErr|APgoodbye'"/>
                <assign name="status" expr="'endCall'"/>
                <assign name="gotoForm" expr="'#exit'"/>
            </if>
			<goto next="#playAudio"/>
        </block>
    </form>

    <form id="exit">
        <block>
            <exit namelist="status"/>
        </block>
    </form>

</vxml>
