<?xml version="1.0"?>
<vxml version="2.0">
    <!-- Last Modified 08/31/2011
       *   @Name        Audio-prompt.vxml
       *   @Desc        This script allows a developer play audio / speech
                                and collect user inputs. An MRCP server is needed for speech. -->
    <!-- Operators
        P :Prompt
        D :Date
        C :Currency
        N :Number
        V :Digits
        S :Speech
        T :Time
        E :Streaming-->

    <script src="file:/interact/apps/spotbuild/lib/js/lib.js"></script>     <!-- Location of java script file -->

    <property name="termchar" value=""/>        <!-- Default terminating character to nothing -->
    <property name="timeout" value="0s"/>       <!-- Default timeout property to zero-->
    <property name="bargein" value="true"/>     <!-- Default bargein to true -->
    <property name="termtimeout" value="0s"/>   <!-- Default termination timeout property to zero-->
    <property name="inputmodes" value="dtmf"/>  <!-- Default inputmodes to dtmf -->

    <property name="confidencelevel" value="1"/>        <!--  confidencelevel. This is the speech recognition confidence level -->
    <property name="maxspeechtimeout" value="0s"/>      <!--  maxspeechtimeout. This is the maximum time allowed for a speech -->
    <property name="incompletetimeout" value="0s"/>     <!--  incompletetimeout. This is the length of silence after an incompletely recognized speech -->
    <property name="completetimeout" value="500ms"/>    <!--  completetimeout. This is the length of silence after a recognized speech  -->

    <!-- Voice properties -->
    <var name="maxSpch"/>     <!--  maxspeechtimeout. This is the maximum time allowed for a speech -->
    <var name="cnfLevel"/>    <!--  confidencelevel. This is the speech recognition confidence level -->
    <var name="cmplTime"/>    <!--  completetimeout. This is the length of silence after a recognized speech  -->
    <var name="incmplTime"/>  <!--  incompletetimeout. This is the length of silence after an incompletely recognized speech -->

    <!-- DTMF properties -->
    <var name="fldLength"/>   <!--  DTMF Length. Defines how many digits/characters are allowed for a particular DTMF input -->
    <var name="hotKeyList"/>  <!--  List of hot keys -->
    <var name="fldTimeOut"/>  <!--  Timeout. Controls how long to wait before throwing a noinput event -->
    <var name="dgtTimeOut"/>  <!--  DTMF Interdigit time out. Controls number of seconds between key presses at an input field -->
    <var name="fldTermChar"/> <!--  DTMF Terminating Character. Identifies the terminating character of a DTMF input -->

    <!-- Prompt properties -->
    <var name="cutIn"/>         <!--  Cut In. true / false - Controls if prompts are interruptable with a key press -->
    <var name="repeat"/>        <!-- Repeat prompt list -->
    <var name="promptList"/>    <!--  List of audio files / speech to play -->

    <!-- Misc Properties -->
    <var name="mode" expr="'dtmf'"/>   <!--  Input Mode. This allows the system to detect either dtmf, voice or both voic and dtmf -->

    <!-- Global variables -->
    <var name="index" expr="0"/>          <!-- Index. Used as a counter when looping through a list of items -->
    <var name="listCnt" expr="0"/>        <!-- List Counter. Another counter used to loop through items -->
    <var name="item" expr="''"/>          <!-- Item. Stores the value of a prompt type -->
    <var name="promptID" expr="''"/>      <!-- Prompt ID. Prompt to play -->
    <var name="plyAudio" expr="''"/>      <!-- Play Audio. Flag to indicate if a prompt should be played -->
    <var name="plySpch" expr="''"/>       <!-- Play Speech. Flag to indicate if prompt should be played as speech -->
    <var name="AUDIO_PATH" expr="'/interact/apps/spotbuild/ippbx/audio/'"/>
    <var name="SYS_PATH" expr="'/interact/apps/spotbuild/audio/system/'"/>    <!-- System Path. System audio lib directory -->
    <var name="AUDIO_EXT" expr="'.00.wav'"/>        <!-- Audio Extension. Extension added to audio file name -->
    <var name="whichPath" expr="AUDIO_PATH"/>                           <!-- Default audio path for current project -->
    <var name="gotoForm" expr="''"/>      <!-- Goto Form. Holds name of next form -->
    <var name="activeList" expr="''"/>    <!-- Active List. Holds value of prompt currently being played -->
    <var name="plyOrdinal" expr="'n'"/>   <!-- Play Ordinal. Flag to indicate if number value should be played as an ordinal -->
    <var name="plyAs" expr="''"/>         <!-- Play As. Holds information on what prompt should be played as -->
    <var name="userEntry" expr="''"/>     <!-- User Entry. Stores value received from user -->

    <form id="begin">
        <!-- Bargein property is defaulted to true. So first check if user set interrupt to false.
             If so, reset bargein to false. Otherwise go check the input mode -->
        <block>
            <log>INFO: Entered begin</log>
            <if cond="hotKeyList == undefined">
                <assign name="hotKeyList" expr="''"/>
            </if>
            <if cond="fldTermChar == undefined">
                <assign name="fldTermChar" expr="''"/>
            </if>
            <if cond="((repeat == undefined) || (repeat.length == 0))">
                <assign name="repeat" expr="'n'"/>
            </if>
            <if cond="((cutIn == undefined) || (cutIn.length == 0))">
                <assign name="cutIn" expr="'true'"/>
            </if>
            <if cond="((fldLength == undefined) || (fldLength &lt; 0))">
                <assign name="fldLength" expr="''"/>
            </if>
            <if cond="((fldTimeOut == undefined) || (fldTimeOut.length &lt; 2))">
                <assign name="fldTimeOut" expr="'0s'"/>
            </if>
            <if cond="((dgtTimeOut == undefined) || (dgtTimeOut.length &lt; 2))">
                <assign name="dgtTimeOut" expr="'0s'"/>
            </if>
            <log>INFO: Audio Interruptible [<value expr="cutIn"/>]</log>
            <if cond="cutIn == 'true'">
                <goto next="#chkMode"/>
            </if>
        </block>
        <object name="interrupt" classid="com.iivip.setproperty">
            <param name="PropertyName" value="bargein"/>
            <param name="PropertyValue" expr="cutIn"/>
            <param name="PropertyScope" value="Document"/>
        </object>
        <block>
            <goto next="#chkMode"/>
        </block>
    </form>

    <form id="chkMode">  <!-- Input mode is defaulted to dtmf. If user has set it voice, set up speech properties -->
        <block>
            <log>INFO: Entered chkMode</log>
            <log>INFO: Input Mode [<value expr="mode"/>]</log>
            <if cond="inString('voice', mode, ' ')">
                <goto next="#setVoice"/>
            <else/>
                <goto next="#getItem"/>
            </if>
        </block>
    </form>

    <form id="setVoice">
        <block>
            <log>INFO: Entered setVoice</log>
            <!-- Set speech related properties -->
        </block>
        <property name='com.iivip.voicechanneltype' value='echo'/>
        <object name="inputMode" classid="com.iivip.setproperty">
            <param name="PropertyName" value="inputmodes"/>
            <param name="PropertyValue" expr="mode"/>
            <param name="PropertyScope" value="Document"/>
        </object>
        <object name="speech" classid="com.iivip.setproperty">
            <param name="PropertyName" value="maxspeechtimeout"/>
            <param name="PropertyValue" expr="maxSpch"/>
            <param name="PropertyScope" value="Document"/>
        </object>
        <object name="cmTime" classid="com.iivip.setproperty">
            <param name="PropertyName" value="completetimeout"/>
            <param name="PropertyValue" expr="cmplTime"/>
            <param name="PropertyScope" value="Document"/>
        </object>
        <object name="incmTime" classid="com.iivip.setproperty">
            <param name="PropertyName" value="incompletetimeout"/>
            <param name="PropertyValue" expr="incmplTime"/>
            <param name="PropertyScope" value="Document"/>
        </object>
        <object name="level" classid="com.iivip.setproperty">
            <param name="PropertyName" value="confidencelevel"/>
            <param name="PropertyValue" expr="cnfLevel"/>
            <param name="PropertyScope" value="Document"/>
        </object>
        <block>
            <log>INFO: Maximum Speech Time [<value expr="maxSpch"/>]</log>
            <log>INFO: Complete Timeout [<value expr="cmplTime"/>]</log>
            <log>INFO: Incomplete Timeout [<value expr="incmplTime"/>]</log>
            <log>INFO: Confidence Level [<value expr="cnfLevel"/>]</log>
            <goto next="#getItem"/>
        </block>
    </form>

    <form id="getItem"> <!-- Audio is passed into template as a pipe delimited list of operators and values -->
        <block>
            <log>INFO: Entered getItem</log>
            <assign name="plyAudio" expr="'y'"/>
            <assign name="plySpch" expr="'n'"/>
            <assign name="plyOrdinal" expr="'n'"/>
            <assign name="plyAs" expr="''"/>
            <assign name="item" expr="getNextElement(index, promptList, '|')"/>       <!-- Extract prompts from input list -->
            <assign name="index" expr="index + 1"/>
            <assign name="gotoForm" expr="'#getItem'"/>
            <assign name="listCnt" expr="0"/>
            <if cond="((item != '-1') &amp;&amp; (item != ''))">    <!-- Check that item is not an empty string and we have not reached the end of the list -->
                <assign name="promptID" expr="iiSubstr(item, 1 ,item.length)"/> <!-- Seperate prompt from operator -->
                <log>INFO: Index [<value expr="index"/>]</log>
                <log>INFO: Item [<value expr="item"/>]</log>
                <if cond="(item[0] == 'P') || (item[0] == 'E')">    <!-- P. Indicates prompt type is audio file -->
                    <!-- Check if user has specified custom location or prompt group for audio file.
                         If so, use that location for file url and prompt group in file name -->
                    <if cond="inString('/',promptID,'')">
                        <assign name="whichPath" expr="''"/>
                    <else/>
                        <assign name="whichPath" expr="AUDIO_PATH"/>
                    </if>
                    <if cond="inString('.',promptID,'')">
                        <assign name="AUDIO_EXT" expr="''"/>
                    </if>
                    <assign name="promptID" expr="whichPath+promptID+AUDIO_EXT"/>
                    <log>INFO: Attempting to play audio file [<value expr="promptID"/>]</log>
                    <goto next="#getEntry"/>
                <elseif cond="item[0] == 'D'"/>   <!-- D. Indicates prompt type is date -->
                    <if cond="chkExpr(promptID, 'D')">    <!-- Verify that date expression has the right format -->
                        <assign name="gotoForm" expr="'#playList'"/>
                        <assign name="activeList" expr="dateToPrompt(promptID)"/>   <!-- Turn expression into an array of prompts -->
                        <log>INFO: Attempting to play date [<value expr="activeList"/>]</log>
                        <goto next="#playList"/>
                    <else/>
                        <log>ERROR: Invalid date format [<value expr="promptID"/>]. Skipping this item...</log>
                    </if>
                <elseif cond="item[0] == 'C'"/>   <!-- C. Indicates prompt type is currency -->
                    <if cond="chkExpr(promptID, 'C')">    <!-- Verify that expression is valid -->
                        <assign name="gotoForm" expr="'#playList'"/>
                        <assign name="activeList" expr="currencyToPrompt(promptID)"/>   <!-- Turn expression into an array of prompts -->
                        <log>INFO: Attempting to play currency [<value expr="activeList"/>]</log>
                        <goto next="#playList"/>
                    <else/>
                        <log>ERROR: Invalid currency format [<value expr="promptID"/>]. Skipping this item...</log>
                    </if>
                <elseif cond="item[0] == 'N'"/>   <!-- N. Indicates prompt type is number -->
                    <if cond="inString('ord', promptID,'_')"> <!-- Check if user wants to play as ordinal -->
                        <assign name="plyOrdinal" expr="'y'"/>
                        <assign name="promptID" expr="getNextElement(0,promptID,'_ord')"/>
                    </if>
                    <if cond="chkExpr(promptID, 'N')">    <!-- Verify that expression is valid -->
                        <assign name="gotoForm" expr="'#playNumbers'"/>
                        <assign name="activeList" expr="numberToPrompt(promptID)"/> <!-- Turn expression into an array of prompts -->
                        <log>INFO: Attempting to play number [<value expr="activeList"/>]</log>
                        <goto next="#playNumbers"/>
                    <else/>
                        <log>ERROR: Invalid number format [<value expr="promptID"/>]. Skipping this item...</log>
                    </if>
                <elseif cond="item[0] == 'V'"/>   <!-- V. Indicates prompt type is digit -->
                    <assign name="gotoForm" expr="'#playDigits'"/>
                    <if cond="inString('ord', promptID,'_')">   <!-- Check if digits are to be played as ordinals -->
                        <assign name="plyOrdinal" expr="'y'"/>
                        <assign name="activeList" expr="getNextElement(0,promptID,'_ord')"/>
                    <else/>
                        <assign name="activeList" expr="promptID"/>
                    </if>
                    <log>INFO: Attempting to play digits [<value expr="activeList"/>]</log>
                    <goto next="#playDigits"/>
                <elseif cond="item[0] == 'S'"/>   <!-- S. Indicates prompt type is speech -->
                    <assign name="plyAudio" expr="'n'"/>
                    <assign name="plySpch" expr="'y'"/>
                    <if cond="inString('_',promptID,'')">   <!-- Check for speech interpretation -->
                        <assign name="plyAs" expr="getNextElement(1,promptID,'_')"/>
                        <assign name="promptID" expr="getNextElement(0,promptID,'_')"/>
                        <if cond="((plyAs == 'currency') || (plyAs == 'number'))">  <!-- For currency and number, substitute '*' with '.' -->
                            <assign name="promptID" expr="iiReplace(promptID,'*','.')"/>
                        <elseif cond="plyAs == 'phone'"/>
                            <assign name="promptID" expr="iiReplace(promptID,'*','x')"/>    <!-- For phone, substitute '*' with 'x' for extension -->
                        </if>
                    </if>
                    <log>INFO: Attempting to play speech [<value expr="promptID"/>]</log>
                    <goto next="#getEntry"/>
                <elseif cond="item[0] == 'T'"/>   <!-- T. Indicates prompt type is Time -->
                    <if cond="chkExpr(promptID, 'T')">    <!-- Verify that expression is valid -->
                        <assign name="gotoForm" expr="'#playList'"/>
                        <assign name="activeList" expr="timeFormat(promptID)"/> <!-- Turn expression into an array of prompts -->
                        <log>INFO: Attempting to play time [<value expr="activeList"/>]</log>
                        <goto next="#playList"/>
                    <else/>
                        <log>ERROR: Invalid time format [<value expr="promptID"/>]. Skipping this item...</log>
                    </if>
                <else/>
                    <log>ERROR: Invalid format. Skipping this item...</log>     <!-- Template somehow received an item with an invalid operator -->
                </if>
            <else/>
                <log>INFO: Played all audio types</log>
                <if cond="fldTimeOut != ''">      <!-- We've gone through the list of prompts, check if we need to wait for user input -->
                    <log>INFO: Waiting for input...</log>
                    <goto next="#setTimeout"/>
                <else/>
                    <if cond="repeat == 'y'">
                        <assign name="index" expr="0"/>
                        <goto next="#getItem"/>
                    <else/>
                        <goto next="#exit"/>
                    </if>
                </if>
            </if>
            <goto next="#getItem"/>
        </block>
    </form>

    <form id="playDigits">  <!-- Extract each digit in the active list and build a prompt to play -->
        <block>
            <log>INFO: Entered playDigits</log>
            <assign name="promptID" expr="getNextElement(listCnt, activeList ,'')"/>
            <assign name="listCnt" expr="listCnt + 1"/>
            <if cond="promptID != ''">    <!-- Verify that this value is not an empty string -->
                <if cond="promptID != '-1'">  <!-- Verify that we are not at the end of the list of digits -->
                    <if cond="plyOrdinal == 'n'"> <!-- Set up regular or ordinal prompt -->
                        <assign name="promptID" expr="SYS_PATH + promptID + AUDIO_EXT"/>
                    <else/>
                        <assign name="promptID" expr="SYS_PATH + 'ordinal_'+ promptID + AUDIO_EXT"/>
                    </if>
                    <goto next="#getEntry"/>    <!-- Go play audio file -->
                <else/>
                    <goto next="#getItem"/>     <!-- We've gone through the list of digits. Go check if there are any more items on the original prompt list -->
                </if>
            <else/>     <!-- Somehow, we pulled an empty string off the list. Check if there are any more digits -->
                <goto next="#playDigits"/>
            </if>
        </block>
    </form>

    <form id="playNumbers"> <!-- Extract each number in the active list and build a prompt to play -->
        <block>
            <log>INFO: Entered playNumbers</log>
            <assign name="promptID" expr="getNextElement(listCnt, activeList ,'|')"/>
            <assign name="listCnt" expr="listCnt + 1"/>
            <if cond="promptID != ''">    <!-- Verify that this value is not an empty string -->
                <if cond="promptID != '-1'">  <!-- Verify that we are not at the end of the list of numbers -->
                    <!-- The logic below checks if we are on the last item of our list.
                         If so, we want to check if the user wants this number played as an ordinal.
                         If both these are true, we need to set up the right prompt -->
                    <if cond="((listCnt+1) == (iiStrCnt(activeList,'|')) &amp;&amp; (plyOrdinal == 'y'))">
                        <assign name="promptID" expr="SYS_PATH + 'ordinal_'+ promptID + AUDIO_EXT"/>
                    <else/>
                        <assign name="promptID" expr="SYS_PATH + promptID + AUDIO_EXT"/>
                    </if>
                    <goto next="#getEntry"/>    <!-- Go play audio file -->
                <else/>
                    <goto next="#getItem"/>     <!-- We've gone through the list of numbers. Go check if there are any more items on the original prompt list -->
                </if>
            <else/>
                <goto next="#playNumbers"/>     <!-- Somehow, we pulled an empty string off the list. Check if there are any more numbers -->
            </if>
        </block>
    </form>

    <form id="playList">    <!-- Extract each value in the active list and build a prompt to play -->
        <block>
            <log>INFO: Entered playList</log>
            <assign name="promptID" expr="getNextElement(listCnt, activeList ,'|')"/>
            <assign name="listCnt" expr="listCnt + 1"/>
            <if cond="promptID != ''">    <!-- Verify that this value is not an empty string -->
                <if cond="promptID != '-1'">  <!-- Verify that we are not at the end of the list -->
                    <assign name="promptID" expr="SYS_PATH + promptID + AUDIO_EXT"/>
                    <goto next="#getEntry"/>    <!-- Go play audio file -->
                <else/>
                    <goto next="#getItem"/>     <!-- We've gone through the list. Go check if there are any more items on the original prompt list -->
                </if>
            <else/>
                <goto next="#playList"/>     <!-- Somehow, we pulled an empty string off the list. Check if there are any more values on the list -->
            </if>
        </block>
    </form>

    <form id="setTimeout">  <!-- Update timeout property, and go wait for input -->
        <block>
            <log>INFO: Entered setTimeout</log>
        </block>
        <object name="dgt" classid="com.iivip.setproperty">
            <param name="PropertyName" value="timeout"/>
            <param name="PropertyValue" expr="fldTimeOut"/>
            <param name="PropertyScope" value="Document"/>
        </object>
        <block>
            <assign name="plyAudio" expr="'n'"/>
            <assign name="plySpch" expr="'n'"/>
            <assign name="gotoForm" expr="'#exit'"/>
            <goto next="#getEntry"/>
        </block>
    </form>

    <menu id="getEntry">
        <!-- This menu can play a specified audio prompt or speech. It can also collect a single key press
             or attempt to match a user defined grammar. If we need to collect multiple key presses,
             we'll just loop over our menu until we are stopped by a termination rule - time out,
             term char or max keys allowed. -->
        <choice dtmf="0" next="#chkEntry"/>     <!-- A user key press will transfer control to the chkEntry form -->
        <choice dtmf="1" next="#chkEntry"/>
        <choice dtmf="2" next="#chkEntry"/>
        <choice dtmf="3" next="#chkEntry"/>
        <choice dtmf="4" next="#chkEntry"/>
        <choice dtmf="5" next="#chkEntry"/>
        <choice dtmf="6" next="#chkEntry"/>
        <choice dtmf="7" next="#chkEntry"/>
        <choice dtmf="8" next="#chkEntry"/>
        <choice dtmf="9" next="#chkEntry"/>
        <choice dtmf="*" next="#chkEntry"/>
        <choice dtmf="#" next="#chkEntry"/>
        <choice next="#getSpeech"> <!-- A user's speech will transfer control to the getSpeech form -->
        </choice>
        <noinput>       <!-- Did not get a key press before specified timeout -->
            <if cond="gotoForm == ''">
                <goto next="#exit"/>
            <else/>
                <goto expr="gotoForm"/>
            </if>
        </noinput>
        <nomatch>
            <if cond="inString('voice', mode, ' ')">      <!-- If input mode is set up for voice, store interpretation -->
                <assign name="userEntry" expr="application.lastresult$.interpretation"/>
            <else/>
                <!-- Something weird happened! Application received a key press it couldn't match -->
            </if>
            <goto next="#exit"/>
        </nomatch>
        <prompt cond="plyAudio == 'y'"> <!-- Attempt to play specified audio file -->
            <audio expr="promptID"/>
        </prompt>
        <prompt cond="((plySpch == 'y') &amp;&amp; (plyAs == ''))">
            <value expr="promptID"/>
        </prompt>
        <prompt cond="((plySpch == 'y') &amp;&amp; (plyAs == 'boolean'))">
            <say-as interpret-as="vxml:boolean">
                <value expr="promptID"/>
            </say-as>
        </prompt>
        <prompt cond="((plySpch == 'y') &amp;&amp; (plyAs == 'date'))">
            <say-as interpret-as="vxml:date">
                <value expr="promptID"/>
            </say-as>
        </prompt>
        <prompt cond="((plySpch == 'y') &amp;&amp; (plyAs == 'digits'))">
            <say-as interpret-as="vxml:digits">
                <value expr="promptID"/>
            </say-as>
        </prompt>
        <prompt cond="((plySpch == 'y') &amp;&amp; (plyAs == 'currency'))">
            <say-as interpret-as="vxml:currency">
                <value expr="promptID"/>
            </say-as>
        </prompt>
        <prompt cond="((plySpch == 'y') &amp;&amp; (plyAs == 'number'))">
            <say-as interpret-as="vxml:number">
                <value expr="promptID"/>
            </say-as>
        </prompt>
        <prompt cond="((plySpch == 'y') &amp;&amp; (plyAs == 'phone'))">
            <say-as interpret-as="vxml:phone">
                <value expr="promptID"/>
            </say-as>
        </prompt>
        <prompt cond="((plySpch == 'y') &amp;&amp; (plyAs == 'time'))">
            <say-as interpret-as="vxml:time">
                <value expr="promptID"/>
            </say-as>
        </prompt>
    </menu>

    <form id="getSpeech">   <!-- Store interpretation of user utterance -->
        <block>
            <assign name="userEntry" expr="application.lastresult$.interpretation"/>
            <goto next="#exit"/>
        </block>
    </form>

    <form id="chkEntry">
        <!-- First thing we do in chkEntry is to prepare for the next key press.
             We update the value of the timeout property with the value
             of the digit time out variable. Our purpose is to give the user the
             same amount of time between each key press -->
        <object name="dgt" classid="com.iivip.setproperty">
            <param name="PropertyName" value="timeout"/>
            <param name="PropertyValue" expr="dgtTimeOut"/>
            <param name="PropertyScope" value="Document"/>
        </object>
        <block cond="hotKeyList.length &gt; 0">
            <!-- If there is any hotkey(s) defined, we'll check only on the first key press.
                 A match will cause us to exit -->
            <assign name="userEntry" expr="application.lastresult$.utterance"/> <!-- Store the user's key press -->
            <if cond="inString(userEntry,hotKeyList,',')">
                <!-- Found a match on the first key press -->
                <log>INFO: User pressed hot key [<value expr="userEntry"/>]</log>
                <goto next="#exit"/>
            <else/>
                <assign name="plyAudio" expr="'n'"/>
                <assign name="plySpch" expr="'n'"/>
                <assign name="gotoForm" expr="''"/>
                <assign name="hotKeyList" expr="''"/>
                <goto next="#getEntry"/>
            </if>
        </block>
        <block>
            <!-- Verify that the user did not press the terminating character
                 and we've not collected the max number of key presses -->
            <if cond="application.lastresult$.utterance != fldTermChar">
                <assign name="userEntry" expr="userEntry + application.lastresult$.utterance"/> <!-- Store the user's key press -->
                <if cond="userEntry.length != fldLength">   <!-- If we've not collected the max allowed, go get next one -->
                    <assign name="plyAudio" expr="'n'"/>
                    <assign name="plySpch" expr="'n'"/>
                    <assign name="gotoForm" expr="''"/>
                    <goto next="#getEntry"/>
                <else/>
                    <log>INFO: Received maximum key presses allowed [<value expr="fldLength"/>]</log>
                </if>
            <else/>
                <log>INFO: Received term key [<value expr="fldTermChar"/>]</log>
            </if>
            <goto next="#exit"/> <!-- We have max allowed input or user pressed term key -->
        </block>
    </form>

    <form id="exit">
        <block>
            <exit namelist="userEntry"/>
        </block>
    </form>

    <catch event="error.noresource">
        <log>ERROR: No resource to play [<value expr="promptID"/>]</log>
        <goto next="#exit"/>
    </catch>
</vxml>