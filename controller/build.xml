<project name="listen-controller" default="war">
  <property name="src.dir"         value="${basedir}/src"/>
  <property name="build.dir"       value="${basedir}/build"/>
  <property name="lib.dir"         value="${basedir}/lib"/>
  <property name="target.dir"      value="${basedir}/target"/>
  <property name="deploy.dir"      value="/interact/listen"/>
  <property name="rpm.staging.dir" value="${target.dir}/staging"/>
  <property name="winstone.jar"    value="winstone-0.9.10.jar"/>
  <property name="war.staging.dir" value="${target.dir}/war/staging"/>
  <property name="tools.dir"       value="tools"/>

  <import file=".build-import-tools.xml"/><!-- import for tools like findbugs, checkstyle, and plots -->

  <path id="javac.classpath">
    <fileset dir="${lib.dir}" includes="**/*.jar"/>
    <pathelement path="${build.dir}/main"/>
  </path>

  <exec outputproperty="deploy.release" executable="svnversion">
      <arg line="-n -c" />
          <redirector>
              <outputfilterchain>
                  <tokenfilter>
                       <replaceregex pattern="^[0-9]*:?" replace="" flags="g"/>
                  </tokenfilter>
              </outputfilterchain>
          </redirector>
  </exec>


  <taskdef resource="tasks.properties" classpathref="javac.classpath"/>
  <taskdef name="findbugs" classname="edu.umd.cs.findbugs.anttask.FindBugsTask" classpath="${tools.dir}/findbugs-1.3.9/lib/findbugs-ant.jar"/>
  <taskdef resource="checkstyletask.properties" classpath="${tools.dir}/checkstyle-5.1/checkstyle-all-5.1.jar"/>

  <target name="clean" description="--> Removes build artifacts created by this script">
    <delete dir="${build.dir}" failonerror="false"/>
    <delete dir="${target.dir}" failonerror="false"/>
    <delete dir="${rpm.staging.dir}" failonerror="false"/>
    <delete dir="${war.staging.dir}" failonerror="false"/>
    <delete failonerror="false">
      <fileset dir="ii_artifacts" includes="**/*"/>
    </delete>
  </target>


  <target name="compile" description="--> Compiles source code into bytecode">
    <mkdir dir="${build.dir}/main"/>
    <javac destdir="${build.dir}/main"
           failonerror="true"
           includeAntRuntime="false"
           debug="true"
           source="6"
           target="6">
       <src path="${src.dir}/main/java"/>
       <classpath refid="javac.classpath"/>
    </javac>
  </target>


  <target name="test" depends="compile" description="--> Runs unit tests">
    <mkdir dir="${target.dir}/junit"/>
    <mkdir dir="${build.dir}/test"/>

    <delete dir="${build.dir}/cobertura" failonerror="false"/>
    <mkdir dir="${build.dir}/cobertura"/>

    <javac destdir="${build.dir}/test"
           failonerror="true"
           includeAntRuntime="false"
           debug="true"
           source="6"
           target="6">
      <src path="${src.dir}/test/java"/>
      <classpath refid="javac.classpath"/>
    </javac>

    <cobertura-instrument todir="${build.dir}/cobertura">
      <fileset dir="${build.dir}/main" includes="**/*.class"/>
    </cobertura-instrument>

    <junit printsummary="on"
           fork="yes"
           forkmode="once"
           showoutput="true">
      <sysproperty key="net.sourceforge.cobertura.datafile" file="${basedir}/cobertura.ser"/>
      <formatter type="xml"/>
      <classpath>
        <pathelement location="${build.dir}/cobertura"/>
        <path refid="javac.classpath"/>
        <pathelement location="${build.dir}/test"/>
      </classpath>

      <batchtest fork="yes"
                 todir="${target.dir}/junit">
        <fileset dir="${src.dir}/test/java" includes="**/*Test.java"/>
      </batchtest>
    </junit>

    <junitreport todir="${target.dir}/junit">
      <fileset dir="${target.dir}/junit" includes="TEST-*.xml"/>
      <report format="frames" todir="${target.dir}/junit"/>
    </junitreport>

    <mkdir dir="${target.dir}/cobertura"/>
    <cobertura-report srcdir="${src.dir}/main/java"
                      destdir="${target.dir}/cobertura"
                      format="html"
                      datafile="${basedir}/cobertura.ser"/>
    <cobertura-report srcdir="${src.dir}/main/java"
                      destdir="${target.dir}/cobertura"
                      format="xml"
                      datafile="${basedir}/cobertura.ser"/>
    <delete file="${basedir}/cobertura.ser"/>
    <delete dir="${build.dir}/cobertura"/>
  </target>


  <target name="war" depends="compile" description="--> Packages distributable war file">
    <mkdir dir="${target.dir}"/>
    <war destfile="${target.dir}/listen-controller.war" webxml="${src.dir}/main/webapp/WEB-INF/web.xml">
      <fileset dir="${src.dir}/main/webapp" includes="**/*"/>
      <classes dir="${build.dir}/main" excludes="**/*Test.class"/>
      <lib dir="${lib.dir}/runtime"/>
    </war>
  </target>

  <target name="jar" depends="war" description="--> Creates an executable jar file with embedded winstone container">
    <mkdir dir="${war.staging.dir}"/>
    <unwar src="${lib.dir}/build/${winstone.jar}" dest="${war.staging.dir}"/>
    <copy file="${target.dir}/listen-controller.war" tofile="${war.staging.dir}/embedded.war"/>
    <jar destfile="${target.dir}/listen-controller.jar" manifest="${war.staging.dir}/META-INF/MANIFEST.MF">
      <fileset dir="${war.staging.dir}" excludes="META-INF/**"/>
    </jar>
  </target>


  <target name="deploy" depends="jar" description="--> Deploys the application">
    <mkdir dir="${deploy.dir}"/>
    <mkdir dir="${deploy.dir}/logs"/>
    <copy file="${target.dir}/listen-controller.war" todir="${deploy.dir}/lib" verbose="true"/>
    <copy file="${target.dir}/listen-controller.jar" todir="${deploy.dir}/lib" verbose="true"/>
    <copy file="${basedir}/scripts/listen-controller" todir="${deploy.dir}/scripts/" verbose="true"/>
  </target>


  <target name="undeploy" description="--> Removes any deployed artifacts">
    <delete dir="${deploy.dir}"/>
  </target>


  <target name="-rpmbuild" depends="deploy">
    <mkdir dir="${rpm.staging.dir}/BUILD"/>

    <exec executable="rpmbuild" failonerror="true">
      <env key="VERSION" value="1.0"/>
      <env key="RELEASE" value="${deploy.release}"/>
      <env key="TOPDIR" value="${rpm.staging.dir}"/>
      <arg line="-bb --buildroot ${rpm.staging.dir}/BUILD ${basedir}/controller.spec"/>
    </exec>

    <copy todir="ii_artifacts" overwrite="true" flatten="true">
      <fileset dir="${rpm.staging.dir}" includes="**/*.rpm"/>
      <fileset dir="${basedir}" includes="*.uia"/>
    </copy>
  </target>


  <target name="rpm" description="--> Creates rpm">
    <!-- hack to override properties -->
    <antcall target="-rpmbuild">
      <param name="deploy.dir" value="${rpm.staging.dir}/BUILD/interact/listen"/>
    </antcall>
  </target>
</project>
